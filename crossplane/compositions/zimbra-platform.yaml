apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: zimbra-platform
  labels:
    platform: zimbra
    type: composition
spec:
  compositeTypeRef:
    apiVersion: idp.example.com/v1alpha1
    kind: XZimbra
  mode: Resources

  resources:
    - name: zimbra-backup-bucket
      base:
        apiVersion: s3.aws.upbound.io/v1beta1
        kind: Bucket
        spec:
          deletionPolicy: Delete
          forProvider:
            region: us-east-1
            tags: {}
          providerConfigRef:
            name: default
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.providerConfigRef.name
          toFieldPath: spec.providerConfigRef.name
          policy:
            fromFieldPath: Optional
        - type: FromCompositeFieldPath
          fromFieldPath: spec.region
          toFieldPath: spec.forProvider.region
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: metadata.annotations[crossplane.io/external-name]
          transforms:
            - type: string
              string:
                fmt: "%s-backup"
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: spec.forProvider.tags.Name
          transforms:
            - type: string
              string:
                fmt: "%s-backup"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.environment
          toFieldPath: spec.forProvider.tags.Environment

    - name: zimbra-vpc
      base:
        apiVersion: ec2.aws.upbound.io/v1beta1
        kind: VPC
        spec:
          deletionPolicy: Delete
          forProvider:
            cidrBlock: 10.0.0.0/16
            enableDnsHostnames: true
            enableDnsSupport: true
            region: us-east-1
            tags: {}
          providerConfigRef:
            name: default
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.providerConfigRef.name
          toFieldPath: spec.providerConfigRef.name
          policy:
            fromFieldPath: Optional
        - type: FromCompositeFieldPath
          fromFieldPath: spec.region
          toFieldPath: spec.forProvider.region
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: spec.forProvider.tags.Name
          transforms:
            - type: string
              string:
                fmt: "%s-vpc"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.environment
          toFieldPath: spec.forProvider.tags.Environment

    - name: zimbra-public-subnet
      base:
        apiVersion: ec2.aws.upbound.io/v1beta1
        kind: Subnet
        spec:
          deletionPolicy: Delete
          forProvider:
            cidrBlock: 10.0.1.0/24
            availabilityZone: us-east-1a
            mapPublicIpOnLaunch: true
            region: us-east-1
            vpcIdSelector:
              matchControllerRef: true
            tags: {}
          providerConfigRef:
            name: default
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.providerConfigRef.name
          toFieldPath: spec.providerConfigRef.name
          policy:
            fromFieldPath: Optional
        - type: FromCompositeFieldPath
          fromFieldPath: spec.region
          toFieldPath: spec.forProvider.region
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: spec.forProvider.tags.Name
          transforms:
            - type: string
              string:
                fmt: "%s-public-subnet"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.environment
          toFieldPath: spec.forProvider.tags.Environment

    - name: zimbra-private-subnet
      base:
        apiVersion: ec2.aws.upbound.io/v1beta1
        kind: Subnet
        spec:
          deletionPolicy: Delete
          forProvider:
            cidrBlock: 10.0.2.0/24
            availabilityZone: us-east-1b
            mapPublicIpOnLaunch: false
            region: us-east-1
            vpcIdSelector:
              matchControllerRef: true
            tags: {}
          providerConfigRef:
            name: default
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.providerConfigRef.name
          toFieldPath: spec.providerConfigRef.name
          policy:
            fromFieldPath: Optional
        - type: FromCompositeFieldPath
          fromFieldPath: spec.region
          toFieldPath: spec.forProvider.region
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: spec.forProvider.tags.Name
          transforms:
            - type: string
              string:
                fmt: "%s-private-subnet"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.environment
          toFieldPath: spec.forProvider.tags.Environment

    - name: zimbra-igw
      base:
        apiVersion: ec2.aws.upbound.io/v1beta1
        kind: InternetGateway
        spec:
          deletionPolicy: Delete
          forProvider:
            region: us-east-1
            vpcIdSelector:
              matchControllerRef: true
            tags: {}
          providerConfigRef:
            name: default
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.providerConfigRef.name
          toFieldPath: spec.providerConfigRef.name
          policy:
            fromFieldPath: Optional
        - type: FromCompositeFieldPath
          fromFieldPath: spec.region
          toFieldPath: spec.forProvider.region
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: spec.forProvider.tags.Name
          transforms:
            - type: string
              string:
                fmt: "%s-igw"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.environment
          toFieldPath: spec.forProvider.tags.Environment

    - name: zimbra-public-rt
      base:
        apiVersion: ec2.aws.upbound.io/v1beta1
        kind: RouteTable
        spec:
          deletionPolicy: Delete
          forProvider:
            region: us-east-1
            vpcIdSelector:
              matchControllerRef: true
            tags: {}
          providerConfigRef:
            name: default
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.providerConfigRef.name
          toFieldPath: spec.providerConfigRef.name
          policy:
            fromFieldPath: Optional
        - type: FromCompositeFieldPath
          fromFieldPath: spec.region
          toFieldPath: spec.forProvider.region
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: spec.forProvider.tags.Name
          transforms:
            - type: string
              string:
                fmt: "%s-public-rt"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.environment
          toFieldPath: spec.forProvider.tags.Environment

    - name: zimbra-public-route
      base:
        apiVersion: ec2.aws.upbound.io/v1beta1
        kind: Route
        spec:
          deletionPolicy: Delete
          forProvider:
            destinationCidrBlock: 0.0.0.0/0
            region: us-east-1
            routeTableIdSelector:
              matchControllerRef: true
            gatewayIdSelector:
              matchControllerRef: true
            tags: {}
          providerConfigRef:
            name: default
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.providerConfigRef.name
          toFieldPath: spec.providerConfigRef.name
          policy:
            fromFieldPath: Optional
        - type: FromCompositeFieldPath
          fromFieldPath: spec.region
          toFieldPath: spec.forProvider.region
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: spec.forProvider.tags.Name
          transforms:
            - type: string
              string:
                fmt: "%s-public-route"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.environment
          toFieldPath: spec.forProvider.tags.Environment

    - name: zimbra-public-rt-assoc
      base:
        apiVersion: ec2.aws.upbound.io/v1beta1
        kind: RouteTableAssociation
        spec:
          deletionPolicy: Delete
          forProvider:
            region: us-east-1
            routeTableIdSelector:
              matchControllerRef: true
            subnetIdSelector:
              matchControllerRef: true
            tags: {}
          providerConfigRef:
            name: default
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.providerConfigRef.name
          toFieldPath: spec.providerConfigRef.name
          policy:
            fromFieldPath: Optional
        - type: FromCompositeFieldPath
          fromFieldPath: spec.region
          toFieldPath: spec.forProvider.region
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: spec.forProvider.tags.Name
          transforms:
            - type: string
              string:
                fmt: "%s-public-rt-assoc"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.environment
          toFieldPath: spec.forProvider.tags.Environment


  
    - name: zimbra-instance-role
      base:
        apiVersion: iam.aws.upbound.io/v1beta1
        kind: Role
        metadata:
          labels:
            app: zimbra
        spec:
          forProvider:
            assumeRolePolicy: |
              {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Principal": {
                      "Service": "ec2.amazonaws.com"
                    },
                    "Action": "sts:AssumeRole"
                  }
                ]
              }
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "%s-ec2-role"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.environment
          toFieldPath: metadata.labels.environment

    - name: zimbra-s3-policy
      base:
        apiVersion: iam.aws.upbound.io/v1beta1
        kind: Policy
        metadata:
          labels:
            app: zimbra
        spec:
          forProvider:
            policy: |
              {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Action": [
                      "s3:PutObject",
                      "s3:GetObject",
                      "s3:DeleteObject",
                      "s3:ListBucket"
                    ],
                    "Resource": [
                      "arn:aws:s3:::*-backup/*",
                      "arn:aws:s3:::*-backup"
                    ]
                  }
                ]
              }
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "%s-s3-policy"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.environment
          toFieldPath: metadata.labels.environment

    - name: zimbra-s3-policy-attachment
      base:
        apiVersion: iam.aws.upbound.io/v1beta1
        kind: RolePolicyAttachment
        metadata:
          labels:
            app: zimbra
        spec:
          forProvider:
            roleSelector:
              matchControllerRef: true
              matchLabels:
                app: zimbra
            policyArnSelector:
              matchControllerRef: true
              matchLabels:
                app: zimbra
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "%s-s3-attach"

    - name: zimbra-instance-profile
      base:
        apiVersion: iam.aws.upbound.io/v1beta1
        kind: InstanceProfile
        metadata:
          labels:
            app: zimbra
        spec:
          forProvider:
            roleSelector:
              matchControllerRef: true
              matchLabels:
                app: zimbra
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: metadata.name
          transforms:
            - type: string
              string:
                fmt: "%s-instance-profile"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.environment
          toFieldPath: metadata.labels.environment

    - name: zimbra-sg-ec2
      base:
        apiVersion: ec2.aws.upbound.io/v1beta1
        kind: SecurityGroup
        metadata:
          labels:
            app: zimbra
            tier: application
        spec:
          forProvider:
            description: Security group for Zimbra EC2 instance
            region: us-east-1
            vpcIdSelector:
              matchControllerRef: true
            tags:
              Name: zimbra-sg-ec2
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.region
          toFieldPath: spec.forProvider.region
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: spec.forProvider.tags.Name
          transforms:
            - type: string
              string:
                fmt: "%s-sg-ec2"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.environment
          toFieldPath: spec.forProvider.tags.Environment

    # Règle Ingress : SSH (port 22)
    - name: zimbra-sg-ec2-rule-ssh
      base:
        apiVersion: ec2.aws.upbound.io/v1beta1
        kind: SecurityGroupRule
        metadata:
          labels:
            app: zimbra
            rule: ssh
        spec:
          forProvider:
            type: ingress
            fromPort: 22
            toPort: 22
            protocol: tcp
            cidrBlocks:
              - 0.0.0.0/0
            description: SSH access
            region: us-east-1
            securityGroupIdSelector:
              matchControllerRef: true
              matchLabels:
                app: zimbra
                tier: application
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.region
          toFieldPath: spec.forProvider.region

    # Règle Ingress : HTTP (port 80)
    - name: zimbra-sg-ec2-rule-http
      base:
        apiVersion: ec2.aws.upbound.io/v1beta1
        kind: SecurityGroupRule
        metadata:
          labels:
            app: zimbra
            rule: http
        spec:
          forProvider:
            type: ingress
            fromPort: 80
            toPort: 80
            protocol: tcp
            cidrBlocks:
              - 0.0.0.0/0
            description: HTTP access for Zimbra webmail
            region: us-east-1
            securityGroupIdSelector:
              matchControllerRef: true
              matchLabels:
                app: zimbra
                tier: application
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.region
          toFieldPath: spec.forProvider.region

    # Règle Ingress : HTTPS (port 443)
    - name: zimbra-sg-ec2-rule-https
      base:
        apiVersion: ec2.aws.upbound.io/v1beta1
        kind: SecurityGroupRule
        metadata:
          labels:
            app: zimbra
            rule: https
        spec:
          forProvider:
            type: ingress
            fromPort: 443
            toPort: 443
            protocol: tcp
            cidrBlocks:
              - 0.0.0.0/0
            description: HTTPS access for Zimbra webmail
            region: us-east-1
            securityGroupIdSelector:
              matchControllerRef: true
              matchLabels:
                app: zimbra
                tier: application
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.region
          toFieldPath: spec.forProvider.region

    # Règle Ingress : SMTP (port 25)
    - name: zimbra-sg-ec2-rule-smtp
      base:
        apiVersion: ec2.aws.upbound.io/v1beta1
        kind: SecurityGroupRule
        metadata:
          labels:
            app: zimbra
            rule: smtp
        spec:
          forProvider:
            type: ingress
            fromPort: 25
            toPort: 25
            protocol: tcp
            cidrBlocks:
              - 0.0.0.0/0
            description: SMTP for email sending
            region: us-east-1
            securityGroupIdSelector:
              matchControllerRef: true
              matchLabels:
                app: zimbra
                tier: application
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.region
          toFieldPath: spec.forProvider.region

    # Règle Ingress : SMTP TLS (port 587)
    - name: zimbra-sg-ec2-rule-smtp-tls
      base:
        apiVersion: ec2.aws.upbound.io/v1beta1
        kind: SecurityGroupRule
        metadata:
          labels:
            app: zimbra
            rule: smtp-tls
        spec:
          forProvider:
            type: ingress
            fromPort: 587
            toPort: 587
            protocol: tcp
            cidrBlocks:
              - 0.0.0.0/0
            description: SMTP TLS for secure email sending
            region: us-east-1
            securityGroupIdSelector:
              matchControllerRef: true
              matchLabels:
                app: zimbra
                tier: application
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.region
          toFieldPath: spec.forProvider.region

    # Règle Ingress : IMAP (port 143)
    - name: zimbra-sg-ec2-rule-imap
      base:
        apiVersion: ec2.aws.upbound.io/v1beta1
        kind: SecurityGroupRule
        metadata:
          labels:
            app: zimbra
            rule: imap
        spec:
          forProvider:
            type: ingress
            fromPort: 143
            toPort: 143
            protocol: tcp
            cidrBlocks:
              - 0.0.0.0/0
            description: IMAP for email retrieval
            region: us-east-1
            securityGroupIdSelector:
              matchControllerRef: true
              matchLabels:
                app: zimbra
                tier: application
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.region
          toFieldPath: spec.forProvider.region

    # Règle Ingress : IMAPS (port 993)
    - name: zimbra-sg-ec2-rule-imaps
      base:
        apiVersion: ec2.aws.upbound.io/v1beta1
        kind: SecurityGroupRule
        metadata:
          labels:
            app: zimbra
            rule: imaps
        spec:
          forProvider:
            type: ingress
            fromPort: 993
            toPort: 993
            protocol: tcp
            cidrBlocks:
              - 0.0.0.0/0
            description: IMAPS for secure email retrieval
            region: us-east-1
            securityGroupIdSelector:
              matchControllerRef: true
              matchLabels:
                app: zimbra
                tier: application
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.region
          toFieldPath: spec.forProvider.region

    # Règle Ingress : Zimbra Admin (port 7071)
    - name: zimbra-sg-ec2-rule-admin
      base:
        apiVersion: ec2.aws.upbound.io/v1beta1
        kind: SecurityGroupRule
        metadata:
          labels:
            app: zimbra
            rule: admin
        spec:
          forProvider:
            type: ingress
            fromPort: 7071
            toPort: 7071
            protocol: tcp
            cidrBlocks:
              - 0.0.0.0/0
            description: Zimbra admin console
            region: us-east-1
            securityGroupIdSelector:
              matchControllerRef: true
              matchLabels:
                app: zimbra
                tier: application
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.region
          toFieldPath: spec.forProvider.region

    # Règle Egress : ALL traffic (sortie)
    - name: zimbra-sg-ec2-rule-egress
      base:
        apiVersion: ec2.aws.upbound.io/v1beta1
        kind: SecurityGroupRule
        metadata:
          labels:
            app: zimbra
            rule: egress
        spec:
          forProvider:
            type: egress
            fromPort: 0
            toPort: 0
            protocol: "-1"
            cidrBlocks:
              - 0.0.0.0/0
            description: Allow all outbound traffic
            region: us-east-1
            securityGroupIdSelector:
              matchControllerRef: true
              matchLabels:
                app: zimbra
                tier: application
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.region
          toFieldPath: spec.forProvider.region

    # Security Group RDS
    - name: zimbra-sg-rds
      base:
        apiVersion: ec2.aws.upbound.io/v1beta1
        kind: SecurityGroup
        metadata:
          labels:
            app: zimbra
            tier: database
        spec:
          forProvider:
            description: Security group for Zimbra RDS MySQL
            region: us-east-1
            vpcIdSelector:
              matchControllerRef: true
            tags:
              Name: zimbra-sg-rds
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.region
          toFieldPath: spec.forProvider.region
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: spec.forProvider.tags.Name
          transforms:
            - type: string
              string:
                fmt: "%s-sg-rds"
        - type: FromCompositeFieldPath
          fromFieldPath: spec.environment
          toFieldPath: spec.forProvider.tags.Environment

    # Règle Ingress RDS : MySQL depuis EC2 uniquement
    - name: zimbra-sg-rds-rule-mysql
      base:
        apiVersion: ec2.aws.upbound.io/v1beta1
        kind: SecurityGroupRule
        metadata:
          labels:
            app: zimbra
            rule: mysql
        spec:
          forProvider:
            type: ingress
            fromPort: 3306
            toPort: 3306
            protocol: tcp
            description: MySQL access from EC2 instances only
            region: us-east-1
            securityGroupIdSelector:
              matchControllerRef: true
              matchLabels:
                app: zimbra
                tier: database
            sourceSecurityGroupIdSelector:
              matchControllerRef: true
              matchLabels:
                app: zimbra
                tier: application
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.region
          toFieldPath: spec.forProvider.region